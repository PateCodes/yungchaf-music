
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------- Helper functions --------
    function isSignedUp() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedUp() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedUp() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isSuperAdmin() {
       return isAdmin() && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'super-admin';
    }

    // -------- Users --------
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // -------- Admins --------
    match /admins/{userId} {
      allow get: if isSignedUp(); // Allow any signed in user to check their own admin status
      allow list: if isAdmin();
      allow write, delete: if isSuperAdmin();
    }

    // -------- Fans --------
    match /fans/{fanId} {
      allow get, list: if isSignedUp();
      allow update: if isOwner(fanId) || isAdmin();
      allow create, delete: if isAdmin(); // Only admins can create/delete fan records directly

      // Notifications subcollection
      match /notifications/{notificationId} {
        allow read, write: if isOwner(fanId);
        allow create: if isAdmin(); // Only admins can create notifications
      }
    }

    // -------- Messages --------
    match /messages/{messageId} {
      allow create: if true; // Anyone can send a message
      allow read: if isAdmin() || isOwner(resource.data.fanId); // Admin or owner can read
      allow list, update, delete: if isAdmin(); // Only admin can list all, update, or delete
    }

    // -------- Music --------
    match /music/{musicId} {
      allow read, write: if isAdmin();
      allow list: if true;

      // Rules for subcollections
      match /likes/{likeId} {
        allow read: if true;
        allow create: if isSignedUp() && request.resource.data.fanId == request.auth.uid;
        allow delete: if isOwner(resource.data.fanId) || isAdmin();
      }

      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedUp() && request.resource.data.fanId == request.auth.uid;
        // Allow anyone signed in to update (for likes/reactions), but only owner/admin to delete.
        allow update: if isSignedUp();
        allow delete: if isOwner(resource.data.fanId) || isAdmin();
      }
    }

    // -------- Contributions --------
    match /contributions/{contributionId} {
      // Admins have full read/write access.
      allow read, write: if isAdmin();

      // Fans can list their own contributions.
      allow list: if isSignedUp() && request.query.where.fanId == request.auth.uid;
      
      // Fans can get one of their own contributions.
      allow get: if isSignedUp() && isOwner(resource.data.fanId);
      
      // A signed-in user can create a contribution for themselves.
      allow create: if isSignedUp() && isOwner(request.resource.data.fanId);
    }

    // -------- PaymentMethods --------
    match /paymentMethods/{methodId} {
      allow get, list: if true; // Publicly readable for the support page
      allow create, update, delete: if isAdmin();
    }

    // -------- Collection group queries for admin dashboard --------
    match /{path=**}/likes/{likeId} {
       allow read: if isAdmin();
    }

    match /{path=**}/comments/{commentId} {
      allow read: if isAdmin();
    }
  }
}
